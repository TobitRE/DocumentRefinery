{% extends "dashboard/base.html" %}

{% block title %}Document Refinery — API Key{% endblock %}

{% block content %}
  <section class="card">
    <div class="row" style="justify-content: space-between;">
      <div>
        <h3>{{ key.name }}</h3>
        <div class="muted">Tenant: {{ key.tenant.name }} · Prefix: <span class="mono">{{ key.prefix }}</span></div>
      </div>
      <a class="pill" href="/dashboard/api-keys/">Back to keys</a>
    </div>
  </section>

  {% if raw_key %}
    <section class="card">
      <h3>Rotated key</h3>
      <div class="panel mono">{{ raw_key }}</div>
      <div class="muted">Copy this key now. It will not be shown again.</div>
    </section>
  {% endif %}

  {% if errors %}
    <section class="card">
      <h3>Errors</h3>
      <div class="error">{{ errors }}</div>
    </section>
  {% endif %}

  <section class="card">
    <h3>Details</h3>
    <div class="grid">
      <div class="panel">
        <div class="muted">Status</div>
        <div>{{ key.active|yesno:"Active,Inactive" }}</div>
      </div>
      <div class="panel">
        <div class="muted">Created</div>
        <div class="mono">{{ key.created_at|date:"Y-m-d H:i" }}</div>
      </div>
      <div class="panel">
        <div class="muted">Last used</div>
        <div class="mono">{{ key.last_used_at|date:"Y-m-d H:i"|default:"—" }}</div>
      </div>
      <div class="panel">
        <div class="muted">Key hash</div>
        <div class="mono">{{ key.key_hash }}</div>
      </div>
    </div>
  </section>

  <section class="card">
    <h3>Update</h3>
    <form method="post" class="form-grid">
      {% csrf_token %}
      <input type="hidden" name="action" value="update" />
      <div class="field">
        <label for="name">Name</label>
        <input type="text" name="name" id="name" value="{{ key.name }}" required />
      </div>
      <div class="field">
        <label for="scopes">Scopes (comma-separated)</label>
        <input type="text" name="scopes" id="scopes" value="{{ key.scopes|join:", " }}" />
      </div>
      <div class="field">
        <label for="allowed_upload_mime_types">Allowed Upload File Types (MIME, comma-separated)</label>
        <input
          type="text"
          name="allowed_upload_mime_types"
          id="allowed_upload_mime_types"
          value="{{ allowed_upload_mime_types_text }}"
          placeholder="application/pdf, application/x-pdf"
          required
        />
        <div class="muted">Restricts file types accepted at <span class="mono">/v1/documents/</span>.</div>
      </div>
      <div class="panel">
        <div class="muted">Quick scopes</div>
        <div class="row">
          <button type="button" class="ghost" data-scope-mode="replace" data-scopes="dashboard:read,jobs:read,jobs:write,artifacts:read">Set dashboard viewer</button>
          <span class="muted">Dashboard metrics + jobs + artifacts with retry controls.</span>
        </div>
        <div class="row">
          <button type="button" class="ghost" data-scopes="documents:read,documents:write">Add document ingest</button>
          <span class="muted">Upload and list documents.</span>
        </div>
        <div class="row">
          <button type="button" class="ghost" data-scopes="webhooks:read,webhooks:write">Add webhooks admin</button>
          <span class="muted">Manage webhook endpoints.</span>
        </div>
        <div class="row">
          <button type="button" class="ghost" data-scope-mode="replace" data-scopes="documents:read,documents:write,artifacts:read,jobs:read,jobs:write,webhooks:read,webhooks:write,dashboard:read">Set full access</button>
          <span class="muted">All API capabilities for this service.</span>
        </div>
        <div class="muted">Scopes control which API endpoints the key can call.</div>
      </div>
      <div class="field">
        <label for="docling_options_json">Docling defaults (JSON, optional)</label>
        <textarea name="docling_options_json" id="docling_options_json">{{ docling_options_text }}</textarea>
      </div>
      <div class="row">
        <label class="pill">
          <input type="checkbox" name="active" {% if key.active %}checked{% endif %} />
          Active
        </label>
      </div>
      <div class="actions">
        <button type="submit">Save changes</button>
        <button type="submit" name="action" value="rotate" class="secondary">Rotate key</button>
      </div>
    </form>
  </section>
  <script>
    const scopesInput = document.getElementById("scopes");
    document.querySelectorAll("[data-scopes]").forEach((btn) => {
      btn.addEventListener("click", () => {
        const mode = btn.dataset.scopeMode || "add";
        const incoming = btn.dataset.scopes
          .split(",")
          .map((value) => value.trim())
          .filter(Boolean);
        if (mode === "replace") {
          scopesInput.value = incoming.join(", ");
          return;
        }
        const existing = scopesInput.value
          .split(",")
          .map((value) => value.trim())
          .filter(Boolean);
        const merged = Array.from(new Set([...existing, ...incoming]));
        scopesInput.value = merged.join(", ");
      });
    });
  </script>
{% endblock %}
