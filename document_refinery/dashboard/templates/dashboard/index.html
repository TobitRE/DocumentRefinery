{% extends "dashboard/base.html" %}

{% block title %}Document Refinery — Ops Dashboard{% endblock %}

{% block header_extra %}
  <div class="card" style="padding: 16px 18px;">
    <div class="row" style="justify-content: space-between;">
      <div style="min-width: min(420px, 100%); display: grid; gap: 8px;">
        <label for="apiKeyInput" class="muted" style="text-transform: uppercase; letter-spacing: 0.12em; font-size: 12px;">API key</label>
        <input id="apiKeyInput" placeholder="Api-Key ..." autocomplete="off" />
        <div class="actions">
          <button id="saveKeyBtn">Save key</button>
          <button class="secondary" id="refreshBtn">Refresh data</button>
        </div>
        <div class="row muted" style="gap: 10px;">
          <label class="pill" style="cursor: pointer;">
            <input type="checkbox" id="autoRefresh" />
            Auto-refresh (10s)
          </label>
          <span>Last update: <span id="lastUpdated">—</span></span>
        </div>
        <div class="muted" id="statusLine">Waiting for API key.</div>
      </div>
    </div>
  </div>
{% endblock %}

{% block content %}
  <section class="grid">
    <div class="card">
      <h3>Queued</h3>
      <div class="stat" id="statQueued">—</div>
    </div>
    <div class="card">
      <h3>Running</h3>
      <div class="stat" id="statRunning">—</div>
    </div>
    <div class="card">
      <h3>Succeeded</h3>
      <div class="stat" id="statSucceeded">—</div>
    </div>
    <div class="card">
      <h3>Failed</h3>
      <div class="stat" id="statFailed">—</div>
    </div>
  </section>

  <section class="grid">
    <div class="card">
      <h3>Durations (24h)</h3>
      <div class="list">
        <div class="mono">Avg: <span id="statAvg">—</span> ms</div>
        <div class="mono">P50: <span id="statP50">—</span> ms</div>
        <div class="mono">P95: <span id="statP95">—</span> ms</div>
        <div class="mono">Total: <span id="statTotal">—</span> ms</div>
      </div>
    </div>
    <div class="card">
      <h3>Stages running</h3>
      <div class="list" id="stagesRunning">No active stages.</div>
    </div>
    <div class="card">
      <h3>Workers</h3>
      <div class="list" id="workerList">—</div>
    </div>
    <div class="card">
      <h3>System status</h3>
      <div class="list" id="systemStatus">—</div>
    </div>
    <div class="card">
      <h3>Metrics (internal)</h3>
      <pre class="metrics" id="metricsText">—</pre>
    </div>
  </section>

  <section class="grid">
    <div class="card">
      <h3>Upload document</h3>
      <div class="form-grid">
        <div class="field">
          <label for="uploadFile">PDF file</label>
          <input type="file" id="uploadFile" accept="application/pdf" />
        </div>
        <div class="field">
          <label for="uploadExternalUuid">External UUID (optional)</label>
          <input type="text" id="uploadExternalUuid" placeholder="e.g. 2f3b12aa-7c4b-4d2e-8a01-8b9d6b6d8d4f" />
        </div>
        <div class="field">
          <label for="uploadProfile">Profile (optional)</label>
          <select id="uploadProfile">
            <option value="">No profile</option>
            <option value="fast_text">fast_text</option>
            <option value="ocr_only">ocr_only</option>
            <option value="structured">structured</option>
            <option value="full_vlm">full_vlm</option>
          </select>
        </div>
        <div class="field">
          <label for="uploadOptionsJson">Docling options JSON (optional)</label>
          <textarea id="uploadOptionsJson" placeholder='{"max_num_pages": 50, "exports": ["markdown","text"]}'></textarea>
        </div>
        <div class="row">
          <label class="pill">
            <input type="checkbox" id="uploadIngest" checked />
            Start ingestion
          </label>
        </div>
        <div class="actions">
          <button id="uploadBtn">Upload</button>
          <button class="ghost" id="clearUploadBtn" type="button">Clear</button>
        </div>
        <div class="panel" id="uploadResult">No upload yet.</div>
      </div>
    </div>

    <div class="card">
      <h3>Job status</h3>
      <div class="form-grid">
        <div class="field">
          <label for="jobIdInput">Job ID</label>
          <input type="text" id="jobIdInput" placeholder="Enter job id to fetch" />
        </div>
        <div class="actions">
          <button class="secondary" id="fetchJobBtn">Fetch status</button>
          <button class="ghost" id="togglePollBtn" type="button">Start polling</button>
        </div>
        <div class="panel" id="jobStatusPanel">No job loaded.</div>
        <div class="panel" id="artifactPanel">No artifacts.</div>
      </div>
    </div>

    <div class="card">
      <h3>Compare profiles</h3>
      <div class="form-grid">
        <div class="field">
          <label for="compareDocumentId">Document ID</label>
          <input type="text" id="compareDocumentId" placeholder="Document id to compare" />
        </div>
        <div class="field">
          <label>Profiles</label>
          <div class="list">
            <label class="pill"><input type="checkbox" name="compareProfiles" value="fast_text" /> fast_text</label>
            <label class="pill"><input type="checkbox" name="compareProfiles" value="ocr_only" /> ocr_only</label>
            <label class="pill"><input type="checkbox" name="compareProfiles" value="structured" /> structured</label>
            <label class="pill"><input type="checkbox" name="compareProfiles" value="full_vlm" /> full_vlm</label>
          </div>
        </div>
        <div class="field">
          <label for="compareOptionsJson">Options JSON (optional)</label>
          <textarea id="compareOptionsJson" placeholder='{"max_num_pages": 50}'></textarea>
        </div>
        <div class="actions">
          <button class="secondary" id="compareRunBtn">Run comparison</button>
        </div>
        <div class="field">
          <label for="compareIdInput">Comparison ID</label>
          <input type="text" id="compareIdInput" placeholder="Paste comparison id to fetch jobs" />
        </div>
        <div class="actions">
          <button class="ghost" id="compareFetchBtn" type="button">Fetch jobs</button>
        </div>
        <div class="panel" id="compareResult">No comparison yet.</div>
      </div>
    </div>
  </section>

  <section class="card">
    <h3>Recent failures</h3>
    <div class="list" id="recentFailures">—</div>
  </section>
{% endblock %}

{% block scripts %}
  <script>
    const statusLine = document.getElementById("statusLine");
    const apiKeyInput = document.getElementById("apiKeyInput");
    const saveKeyBtn = document.getElementById("saveKeyBtn");
    const refreshBtn = document.getElementById("refreshBtn");
    const autoRefresh = document.getElementById("autoRefresh");
    const lastUpdated = document.getElementById("lastUpdated");
    const uploadFile = document.getElementById("uploadFile");
    const uploadExternalUuid = document.getElementById("uploadExternalUuid");
    const uploadProfile = document.getElementById("uploadProfile");
    const uploadOptionsJson = document.getElementById("uploadOptionsJson");
    const uploadIngest = document.getElementById("uploadIngest");
    const uploadBtn = document.getElementById("uploadBtn");
    const clearUploadBtn = document.getElementById("clearUploadBtn");
    const uploadResult = document.getElementById("uploadResult");
    const jobIdInput = document.getElementById("jobIdInput");
    const fetchJobBtn = document.getElementById("fetchJobBtn");
    const togglePollBtn = document.getElementById("togglePollBtn");
    const jobStatusPanel = document.getElementById("jobStatusPanel");
    const artifactPanel = document.getElementById("artifactPanel");
    const compareDocumentId = document.getElementById("compareDocumentId");
    const compareOptionsJson = document.getElementById("compareOptionsJson");
    const compareRunBtn = document.getElementById("compareRunBtn");
    const compareIdInput = document.getElementById("compareIdInput");
    const compareFetchBtn = document.getElementById("compareFetchBtn");
    const compareResult = document.getElementById("compareResult");
    let pollTimer = null;

    const fields = {
      queued: document.getElementById("statQueued"),
      running: document.getElementById("statRunning"),
      succeeded: document.getElementById("statSucceeded"),
      failed: document.getElementById("statFailed"),
      avg: document.getElementById("statAvg"),
      p50: document.getElementById("statP50"),
      p95: document.getElementById("statP95"),
      total: document.getElementById("statTotal"),
      stages: document.getElementById("stagesRunning"),
      workers: document.getElementById("workerList"),
      system: document.getElementById("systemStatus"),
      failures: document.getElementById("recentFailures"),
      metrics: document.getElementById("metricsText"),
    };

    function setStatus(message, isError = false) {
      statusLine.textContent = message;
      statusLine.className = isError ? "error" : "muted";
    }

    function loadSavedKey() {
      const saved = localStorage.getItem("docrefinery_api_key");
      if (saved) {
        apiKeyInput.value = saved;
      }
    }

    function saveKey() {
      localStorage.setItem("docrefinery_api_key", apiKeyInput.value.trim());
      setStatus("API key saved.");
    }

    async function fetchJson(path) {
      const key = apiKeyInput.value.trim();
      if (!key) {
        setStatus("Add an API key to load data.", true);
        throw new Error("missing key");
      }
      const res = await fetch(path, {
        headers: {
          Authorization: `Api-Key ${key}`,
        },
      });
      if (!res.ok) {
        const msg = `Request failed (${res.status})`;
        setStatus(msg, true);
        throw new Error(msg);
      }
      return res.json();
    }

    async function fetchAuthorized(path, options = {}) {
      const key = apiKeyInput.value.trim();
      if (!key) {
        setStatus("Add an API key to load data.", true);
        throw new Error("missing key");
      }
      const headers = options.headers || {};
      headers.Authorization = `Api-Key ${key}`;
      return fetch(path, { ...options, headers });
    }

    function renderSummary(data) {
      fields.queued.textContent = data.jobs.queued ?? 0;
      fields.running.textContent = data.jobs.running ?? 0;
      fields.succeeded.textContent = data.jobs.succeeded ?? 0;
      fields.failed.textContent = data.jobs.failed ?? 0;
      fields.avg.textContent = data.durations_ms.avg_24h ?? "—";
      fields.p50.textContent = data.durations_ms.p50_24h ?? "—";
      fields.p95.textContent = data.durations_ms.p95_24h ?? "—";
      fields.total.textContent = data.durations_ms.total_24h ?? "—";

      const stages = data.stages_running || {};
      const stageEntries = Object.entries(stages);
      fields.stages.innerHTML = stageEntries.length
        ? stageEntries
            .map(
              ([name, count]) =>
                `<div class="pill">${name.toLowerCase()}: ${count}</div>`
            )
            .join("")
        : "No active stages.";

      const failures = data.recent_failures || [];
      fields.failures.innerHTML = failures.length
        ? failures
            .map(
              (item) =>
                `<div class="pill">Job ${item.id} · ${item.error_code || "UNKNOWN"}</div>`
            )
            .join("")
        : "No recent failures.";
    }

    function renderWorkers(data) {
      const workers = data.workers || [];
      fields.workers.innerHTML = workers.length
        ? workers
            .map(
              (worker) =>
                `<div class="pill">${worker.hostname} · ${worker.active_tasks} active</div>`
            )
            .join("")
        : "No workers online.";
    }

    function formatBytes(bytes) {
      if (bytes === null || bytes === undefined) return "—";
      const units = ["B", "KB", "MB", "GB", "TB"];
      let idx = 0;
      let value = bytes;
      while (value >= 1024 && idx < units.length - 1) {
        value /= 1024;
        idx += 1;
      }
      return `${value.toFixed(1)} ${units[idx]}`;
    }

    function formatPercent(value) {
      if (value === null || value === undefined) return "—";
      return `${value.toFixed(1)}%`;
    }

    function formatUptime(seconds) {
      if (!seconds && seconds !== 0) return "—";
      const days = Math.floor(seconds / 86400);
      const hours = Math.floor((seconds % 86400) / 3600);
      const mins = Math.floor((seconds % 3600) / 60);
      if (days > 0) return `${days}d ${hours}h`;
      if (hours > 0) return `${hours}h ${mins}m`;
      return `${mins}m`;
    }

    function renderSystem(data) {
      const cpu = data.cpu || {};
      const mem = data.memory || {};
      const disk = data.disk || {};
      const gpu = data.gpu || {};
      const load = cpu.loadavg ? cpu.loadavg.map((v) => v.toFixed(2)).join(", ") : "—";
      const gpuLine = gpu.available
        ? `gpu: ${gpu.gpus
            .map(
              (item) =>
                `${item.name} · ${item.utilization_pct}% · ${item.memory_used_mb}/${item.memory_total_mb} MB`
            )
            .join(" | ")}`
        : `gpu: ${gpu.reason || "unavailable"}`;
      const driverLine = gpu.driver_version ? `driver: ${gpu.driver_version}` : null;

      fields.system.innerHTML = `
        <div class="pill">db: ${data.checks?.db ? "ok" : "down"}</div>
        <div class="pill">broker: ${data.checks?.broker ? "ok" : "down"}</div>
        <div class="pill">cpu: ${cpu.count ?? "—"} cores · load ${load}</div>
        <div class="pill">mem: ${formatBytes(mem.used)} / ${formatBytes(mem.total)} (${formatPercent(
        mem.percent
      )})</div>
        <div class="pill">disk(/): ${formatBytes(
          disk.root?.used
        )} / ${formatBytes(disk.root?.total)} (${formatPercent(
        disk.root?.percent
      )})</div>
        <div class="pill">disk(data): ${
          disk.data_root
            ? `${formatBytes(disk.data_root.used)} / ${formatBytes(
                disk.data_root.total
              )} (${formatPercent(disk.data_root.percent)})`
            : "n/a"
        }</div>
        <div class="pill">uptime: ${formatUptime(data.uptime_seconds)}</div>
        <div class="pill">${gpuLine}</div>
        ${driverLine ? `<div class="pill">${driverLine}</div>` : ""}
      `;
      fields.metrics.textContent = data.metrics?.text || "—";
    }

    function renderJobStatus(job) {
      if (!job) {
        jobStatusPanel.textContent = "No job loaded.";
        return;
      }
      const status = job.status || "—";
      const stage = job.stage || "—";
      const error = job.error_code ? `${job.error_code}: ${job.error_message || ""}` : "—";
      jobStatusPanel.innerHTML = `
        <div class="list">
          <div class="pill">Status: ${status}</div>
          <div class="pill">Stage: ${stage}</div>
          <div class="pill">External UUID: ${job.external_uuid || "—"}</div>
          <div class="pill">Profile: ${job.profile || "—"}</div>
          <div class="pill">Comparison: ${job.comparison_id || "—"}</div>
          <div class="pill">Queued: ${job.queued_at || "—"}</div>
          <div class="pill">Started: ${job.started_at || "—"}</div>
          <div class="pill">Finished: ${job.finished_at || "—"}</div>
          <div class="pill">Error: ${error}</div>
        </div>
      `;
    }

    function selectedCompareProfiles() {
      return Array.from(document.querySelectorAll("input[name='compareProfiles']:checked")).map(
        (item) => item.value
      );
    }

    function renderComparisonJobs(jobs) {
      if (!jobs || !jobs.length) {
        compareResult.textContent = "No comparison jobs found.";
        return;
      }
      compareResult.innerHTML = jobs
        .map(
          (job) => `
            <div class="row" style="justify-content: space-between;">
              <div class="mono">Job ${job.id} · ${job.profile || "—"} · ${job.status || "—"}</div>
              <button class="secondary" data-job-id="${job.id}">Load</button>
            </div>
          `
        )
        .join("");
      compareResult.querySelectorAll("button[data-job-id]").forEach((btn) => {
        btn.addEventListener("click", () => {
          jobIdInput.value = btn.dataset.jobId;
          fetchJob(btn.dataset.jobId);
        });
      });
    }

    async function fetchComparison(comparisonId) {
      if (!comparisonId) {
        setStatus("Provide a comparison id.", true);
        return;
      }
      try {
        const jobs = await fetchJson(`/v1/jobs/?comparison_id=${comparisonId}`);
        renderComparisonJobs(jobs);
      } catch (err) {
        compareResult.textContent = "Failed to load comparison jobs.";
      }
    }

    async function runComparison() {
      const key = apiKeyInput.value.trim();
      if (!key) {
        setStatus("Select an API key before comparing.", true);
        return;
      }
      const documentId = compareDocumentId.value.trim();
      if (!documentId) {
        setStatus("Provide a document id to compare.", true);
        return;
      }
      const profiles = selectedCompareProfiles();
      if (!profiles.length) {
        setStatus("Select at least one profile.", true);
        return;
      }
      const payload = { profiles };
      const optionsRaw = compareOptionsJson.value.trim();
      if (optionsRaw) {
        try {
          payload.options_json = JSON.parse(optionsRaw);
        } catch (err) {
          setStatus("Options JSON is invalid.", true);
          return;
        }
      }
      compareResult.textContent = "Starting comparison...";
      try {
        const res = await fetchAuthorized(`/v1/documents/${documentId}/compare/`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });
        if (!res.ok) {
          setStatus(`Comparison failed (${res.status})`, true);
          compareResult.textContent = "Comparison failed.";
          return;
        }
        const data = await res.json();
        compareIdInput.value = data.comparison_id || "";
        setStatus("Comparison jobs queued.");
        await fetchComparison(data.comparison_id);
      } catch (err) {
        setStatus("Comparison failed.", true);
        compareResult.textContent = "Comparison failed.";
      }
    }

    function renderArtifacts(items) {
      if (!items || !items.length) {
        artifactPanel.textContent = "No artifacts.";
        return;
      }
      artifactPanel.innerHTML = items
        .map(
          (item) => `
            <div class="row" style="justify-content: space-between;">
              <div class="mono">${item.kind} · ${item.size_bytes ?? "—"} bytes</div>
              <button class="secondary" data-artifact="${item.id}" data-kind="${item.kind}">Download</button>
            </div>
          `
        )
        .join("");
      artifactPanel.querySelectorAll("button[data-artifact]").forEach((btn) => {
        btn.addEventListener("click", () => downloadArtifact(btn.dataset.artifact, btn.dataset.kind));
      });
    }

    async function downloadArtifact(artifactId, kind) {
      try {
        const res = await fetchAuthorized(`/v1/artifacts/${artifactId}/`);
        if (!res.ok) {
          setStatus(`Artifact download failed (${res.status})`, true);
          return;
        }
        const blob = await res.blob();
        const url = URL.createObjectURL(blob);
        const link = document.createElement("a");
        link.href = url;
        link.download = kind || "artifact";
        document.body.appendChild(link);
        link.click();
        link.remove();
        URL.revokeObjectURL(url);
      } catch (err) {
        setStatus("Failed to download artifact.", true);
      }
    }

    async function fetchJob(jobId, withArtifacts = true) {
      if (!jobId) {
        setStatus("Provide a job id.", true);
        return;
      }
      try {
        const job = await fetchJson(`/v1/jobs/${jobId}/`);
        renderJobStatus(job);
        if (withArtifacts && job.status === "SUCCEEDED") {
          const artifacts = await fetchJson(`/v1/artifacts/?job_id=${jobId}`);
          renderArtifacts(artifacts);
        }
        if (["SUCCEEDED", "FAILED", "CANCELED", "QUARANTINED"].includes(job.status)) {
          if (pollTimer) {
            clearInterval(pollTimer);
            pollTimer = null;
            togglePollBtn.textContent = "Start polling";
          }
        }
      } catch (err) {
        renderJobStatus(null);
      }
    }

    async function uploadDocument() {
      const key = apiKeyInput.value.trim();
      if (!key) {
        setStatus("Select an API key before uploading.", true);
        return;
      }
      if (!uploadFile.files.length) {
        setStatus("Select a PDF file to upload.", true);
        return;
      }
      const form = new FormData();
      form.append("file", uploadFile.files[0]);
      if (uploadIngest.checked) {
        form.append("ingest", "true");
      }
      const externalUuid = uploadExternalUuid.value.trim();
      if (externalUuid) {
        form.append("external_uuid", externalUuid);
      }
      const profile = uploadProfile.value;
      if (profile) {
        form.append("profile", profile);
      }
      const optionsRaw = uploadOptionsJson.value.trim();
      if (optionsRaw) {
        try {
          JSON.parse(optionsRaw);
        } catch (err) {
          setStatus("Options JSON is invalid.", true);
          return;
        }
        form.append("options_json", optionsRaw);
      }

      uploadResult.textContent = "Uploading...";
      try {
        const res = await fetchAuthorized("/v1/documents/", {
          method: "POST",
          body: form,
        });
        if (!res.ok) {
          setStatus(`Upload failed (${res.status})`, true);
          uploadResult.textContent = "Upload failed.";
          return;
        }
        const payload = await res.json();
        uploadResult.innerHTML = `Document ${payload.id} · SHA ${payload.sha256 || "—"} · Job ${payload.job_id || "—"}`;
        if (payload.job_id) {
          jobIdInput.value = payload.job_id;
          await fetchJob(payload.job_id);
        }
      } catch (err) {
        setStatus("Upload failed.", true);
        uploadResult.textContent = "Upload failed.";
      }
    }

    function togglePolling() {
      if (pollTimer) {
        clearInterval(pollTimer);
        pollTimer = null;
        togglePollBtn.textContent = "Start polling";
        return;
      }
      const jobId = jobIdInput.value.trim();
      if (!jobId) {
        setStatus("Provide a job id before polling.", true);
        return;
      }
      togglePollBtn.textContent = "Stop polling";
      pollTimer = setInterval(() => fetchJob(jobId), 3000);
      fetchJob(jobId);
    }

    function clearUpload() {
      uploadFile.value = "";
      uploadExternalUuid.value = "";
      uploadProfile.value = "";
      uploadOptionsJson.value = "";
      uploadIngest.checked = true;
      uploadResult.textContent = "No upload yet.";
    }

    async function refresh() {
      setStatus("Loading...");
      try {
        const [summary, workers, system] = await Promise.all([
          fetchJson("/v1/dashboard/summary"),
          fetchJson("/v1/dashboard/workers"),
          fetch("/dashboard/system").then((res) => res.json()),
        ]);
        renderSummary(summary);
        renderWorkers(workers);
        renderSystem(system);
        setStatus("Updated just now.");
        lastUpdated.textContent = new Date().toLocaleTimeString();
      } catch (err) {
        if (!apiKeyInput.value.trim()) {
          return;
        }
        setStatus("Failed to load data.", true);
      }
    }

    saveKeyBtn.addEventListener("click", () => {
      saveKey();
      refresh();
    });
    refreshBtn.addEventListener("click", refresh);
    uploadBtn.addEventListener("click", (event) => {
      event.preventDefault();
      uploadDocument();
    });
    clearUploadBtn.addEventListener("click", (event) => {
      event.preventDefault();
      clearUpload();
    });
    fetchJobBtn.addEventListener("click", (event) => {
      event.preventDefault();
      fetchJob(jobIdInput.value.trim());
    });
    togglePollBtn.addEventListener("click", (event) => {
      event.preventDefault();
      togglePolling();
    });
    compareRunBtn.addEventListener("click", (event) => {
      event.preventDefault();
      runComparison();
    });
    compareFetchBtn.addEventListener("click", (event) => {
      event.preventDefault();
      fetchComparison(compareIdInput.value.trim());
    });
    autoRefresh.addEventListener("change", () => {
      if (autoRefresh.checked) {
        setStatus("Auto-refresh enabled.");
      }
    });

    loadSavedKey();
    if (apiKeyInput.value.trim()) {
      refresh();
    }

    setInterval(() => {
      if (autoRefresh.checked) {
        refresh();
      }
    }, 10000);
  </script>
{% endblock %}
