{% extends "dashboard/base.html" %}

{% block title %}Document Refinery — Ops Dashboard{% endblock %}

{% block header_extra %}
  <div class="card" style="padding: 16px 18px;">
    <div class="row" style="justify-content: space-between;">
      <div style="min-width: min(420px, 100%); display: grid; gap: 8px;">
        <label for="apiKeyInput" class="muted" style="text-transform: uppercase; letter-spacing: 0.12em; font-size: 12px;">API key</label>
        <input id="apiKeyInput" placeholder="Api-Key ..." autocomplete="off" />
        <div class="actions">
          <button id="saveKeyBtn">Save key</button>
          <button class="secondary" id="refreshBtn">Refresh data</button>
        </div>
        <div class="row muted" style="gap: 10px;">
          <label class="pill" style="cursor: pointer;">
            <input type="checkbox" id="autoRefresh" />
            Auto-refresh (10s)
          </label>
          <span>Last update: <span id="lastUpdated">—</span></span>
        </div>
        <div class="muted" id="statusLine">Waiting for API key.</div>
      </div>
    </div>
  </div>
{% endblock %}

{% block content %}
  <section class="grid">
    <div class="card">
      <h3>Queued</h3>
      <div class="stat" id="statQueued">—</div>
    </div>
    <div class="card">
      <h3>Running</h3>
      <div class="stat" id="statRunning">—</div>
    </div>
    <div class="card">
      <h3>Succeeded</h3>
      <div class="stat" id="statSucceeded">—</div>
    </div>
    <div class="card">
      <h3>Failed</h3>
      <div class="stat" id="statFailed">—</div>
    </div>
  </section>

  <section class="grid">
    <div class="card">
      <h3>Durations (24h)</h3>
      <div class="list">
        <div class="mono">Avg: <span id="statAvg">—</span> ms</div>
        <div class="mono">P50: <span id="statP50">—</span> ms</div>
        <div class="mono">P95: <span id="statP95">—</span> ms</div>
        <div class="mono">Total: <span id="statTotal">—</span> ms</div>
      </div>
    </div>
    <div class="card">
      <h3>Stages running</h3>
      <div class="list" id="stagesRunning">No active stages.</div>
    </div>
    <div class="card">
      <h3>Workers</h3>
      <div class="list" id="workerList">—</div>
    </div>
    <div class="card">
      <h3>System status</h3>
      <div class="list" id="systemStatus">—</div>
    </div>
    <div class="card">
      <h3>Metrics (internal)</h3>
      <pre class="metrics" id="metricsText">—</pre>
    </div>
  </section>

  <section class="card">
    <h3>Recent failures</h3>
    <div class="list" id="recentFailures">—</div>
  </section>
{% endblock %}

{% block scripts %}
  <script>
    const statusLine = document.getElementById("statusLine");
    const apiKeyInput = document.getElementById("apiKeyInput");
    const saveKeyBtn = document.getElementById("saveKeyBtn");
    const refreshBtn = document.getElementById("refreshBtn");
    const autoRefresh = document.getElementById("autoRefresh");
    const lastUpdated = document.getElementById("lastUpdated");

    const fields = {
      queued: document.getElementById("statQueued"),
      running: document.getElementById("statRunning"),
      succeeded: document.getElementById("statSucceeded"),
      failed: document.getElementById("statFailed"),
      avg: document.getElementById("statAvg"),
      p50: document.getElementById("statP50"),
      p95: document.getElementById("statP95"),
      total: document.getElementById("statTotal"),
      stages: document.getElementById("stagesRunning"),
      workers: document.getElementById("workerList"),
      system: document.getElementById("systemStatus"),
      failures: document.getElementById("recentFailures"),
      metrics: document.getElementById("metricsText"),
    };

    function setStatus(message, isError = false) {
      statusLine.textContent = message;
      statusLine.className = isError ? "error" : "muted";
    }

    function loadSavedKey() {
      const saved = localStorage.getItem("docrefinery_api_key");
      if (saved) {
        apiKeyInput.value = saved;
      }
    }

    function saveKey() {
      localStorage.setItem("docrefinery_api_key", apiKeyInput.value.trim());
      setStatus("API key saved.");
    }

    async function fetchJson(path) {
      const key = apiKeyInput.value.trim();
      if (!key) {
        setStatus("Add an API key to load data.", true);
        throw new Error("missing key");
      }
      const res = await fetch(path, {
        headers: {
          Authorization: `Api-Key ${key}`,
        },
      });
      if (!res.ok) {
        const msg = `Request failed (${res.status})`;
        setStatus(msg, true);
        throw new Error(msg);
      }
      return res.json();
    }

    function renderSummary(data) {
      fields.queued.textContent = data.jobs.queued ?? 0;
      fields.running.textContent = data.jobs.running ?? 0;
      fields.succeeded.textContent = data.jobs.succeeded ?? 0;
      fields.failed.textContent = data.jobs.failed ?? 0;
      fields.avg.textContent = data.durations_ms.avg_24h ?? "—";
      fields.p50.textContent = data.durations_ms.p50_24h ?? "—";
      fields.p95.textContent = data.durations_ms.p95_24h ?? "—";
      fields.total.textContent = data.durations_ms.total_24h ?? "—";

      const stages = data.stages_running || {};
      const stageEntries = Object.entries(stages);
      fields.stages.innerHTML = stageEntries.length
        ? stageEntries
            .map(
              ([name, count]) =>
                `<div class="pill">${name.toLowerCase()}: ${count}</div>`
            )
            .join("")
        : "No active stages.";

      const failures = data.recent_failures || [];
      fields.failures.innerHTML = failures.length
        ? failures
            .map(
              (item) =>
                `<div class="pill">Job ${item.id} · ${item.error_code || "UNKNOWN"}</div>`
            )
            .join("")
        : "No recent failures.";
    }

    function renderWorkers(data) {
      const workers = data.workers || [];
      fields.workers.innerHTML = workers.length
        ? workers
            .map(
              (worker) =>
                `<div class="pill">${worker.hostname} · ${worker.active_tasks} active</div>`
            )
            .join("")
        : "No workers online.";
    }

    function formatBytes(bytes) {
      if (bytes === null || bytes === undefined) return "—";
      const units = ["B", "KB", "MB", "GB", "TB"];
      let idx = 0;
      let value = bytes;
      while (value >= 1024 && idx < units.length - 1) {
        value /= 1024;
        idx += 1;
      }
      return `${value.toFixed(1)} ${units[idx]}`;
    }

    function formatPercent(value) {
      if (value === null || value === undefined) return "—";
      return `${value.toFixed(1)}%`;
    }

    function formatUptime(seconds) {
      if (!seconds && seconds !== 0) return "—";
      const days = Math.floor(seconds / 86400);
      const hours = Math.floor((seconds % 86400) / 3600);
      const mins = Math.floor((seconds % 3600) / 60);
      if (days > 0) return `${days}d ${hours}h`;
      if (hours > 0) return `${hours}h ${mins}m`;
      return `${mins}m`;
    }

    function renderSystem(data) {
      const cpu = data.cpu || {};
      const mem = data.memory || {};
      const disk = data.disk || {};
      const gpu = data.gpu || {};
      const load = cpu.loadavg ? cpu.loadavg.map((v) => v.toFixed(2)).join(", ") : "—";
      const gpuLine = gpu.available
        ? `gpu: ${gpu.gpus
            .map(
              (item) =>
                `${item.name} · ${item.utilization_pct}% · ${item.memory_used_mb}/${item.memory_total_mb} MB`
            )
            .join(" | ")}`
        : `gpu: ${gpu.reason || "unavailable"}`;
      const driverLine = gpu.driver_version ? `driver: ${gpu.driver_version}` : null;

      fields.system.innerHTML = `
        <div class="pill">db: ${data.checks?.db ? "ok" : "down"}</div>
        <div class="pill">broker: ${data.checks?.broker ? "ok" : "down"}</div>
        <div class="pill">cpu: ${cpu.count ?? "—"} cores · load ${load}</div>
        <div class="pill">mem: ${formatBytes(mem.used)} / ${formatBytes(mem.total)} (${formatPercent(
        mem.percent
      )})</div>
        <div class="pill">disk(/): ${formatBytes(
          disk.root?.used
        )} / ${formatBytes(disk.root?.total)} (${formatPercent(
        disk.root?.percent
      )})</div>
        <div class="pill">disk(data): ${
          disk.data_root
            ? `${formatBytes(disk.data_root.used)} / ${formatBytes(
                disk.data_root.total
              )} (${formatPercent(disk.data_root.percent)})`
            : "n/a"
        }</div>
        <div class="pill">uptime: ${formatUptime(data.uptime_seconds)}</div>
        <div class="pill">${gpuLine}</div>
        ${driverLine ? `<div class="pill">${driverLine}</div>` : ""}
      `;
      fields.metrics.textContent = data.metrics?.text || "—";
    }

    async function refresh() {
      setStatus("Loading...");
      try {
        const [summary, workers, system] = await Promise.all([
          fetchJson("/v1/dashboard/summary"),
          fetchJson("/v1/dashboard/workers"),
          fetch("/dashboard/system").then((res) => res.json()),
        ]);
        renderSummary(summary);
        renderWorkers(workers);
        renderSystem(system);
        setStatus("Updated just now.");
        lastUpdated.textContent = new Date().toLocaleTimeString();
      } catch (err) {
        if (!apiKeyInput.value.trim()) {
          return;
        }
        setStatus("Failed to load data.", true);
      }
    }

    saveKeyBtn.addEventListener("click", () => {
      saveKey();
      refresh();
    });
    refreshBtn.addEventListener("click", refresh);
    autoRefresh.addEventListener("change", () => {
      if (autoRefresh.checked) {
        setStatus("Auto-refresh enabled.");
      }
    });

    loadSavedKey();
    if (apiKeyInput.value.trim()) {
      refresh();
    }

    setInterval(() => {
      if (autoRefresh.checked) {
        refresh();
      }
    }, 10000);
  </script>
{% endblock %}
